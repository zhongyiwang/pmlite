{% extends '_base.html' %}
{% block title %}计划版本管理{% endblock %}
{% block body %}
<!-- 表格 -->
<div class="layui-fluid">
    <table class="layui-hide" id="plan-version-table"></table>
</div>

<!-- 右侧工具栏 -->
<script type="text/html" id="tools">
{% raw %}
{{# if (d.status == "已提交"){ }}
    <a class="layui-btn layui-btn-xs" lay-event="tool-release">发布</a>
{{# } else { }}
    <a class="layui-btn layui-btn-xs layui-btn-disabled" lay-event="tool-release" disabled>发布</a>
{{# } }}
{{# if (d.status != "待提交"){ }}
    <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="tool-cancel">撤销发布</a>
{{# } else { }}
    <a class="layui-btn layui-btn-warm layui-btn-xs layui-btn-disabled" lay-event="tool-cancel" disabled>撤销发布</a>
{{# } }}
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="tool-del">删除</a>
{% endraw %}
</script>

<script>
    // 更改【状态】列的渲染
    function render_status(d) {
        const statusMap = {
            '待提交': '<span class="layui-badge layui-bg-gray">待提交</span>',
            '已提交': '<span class="layui-badge layui-bg-blue">已提交</span>',
            '已发布': '<span class="layui-badge layui-bg-red">已发布</span>'
        };
        return statusMap[d.status] || d.status;
    }

    layui.use(function () {
        var table = layui.table;
        var $ = layui.$;
        var form = layui.form;
        var layer = layui.layer;

        // 渲染表格
        table.render({
            elem: '#plan-version-table',
            id: 'plan-version-table',
            url: '/api/v1/project/plan_version',
            toolbar: true,
            page: true,
            limit: 30,
            height: 'full-15',
            cols: [function (){
                let arr = [   // 标题栏
                    {field: 'id', title: 'ID', minWidth: 30, sort: true, align: 'center', width: 80, hide: true},
                    {field: 'project', title: '项目', minWidth: 80, sort: true, align: 'center', width: 300},
                    {field: 'plan_version', title: '计划版本', minWidth: 80, align: 'center', width: 100},
                    {field: 'status', title: '状态', minWidth: 120, align: 'center', width: 150, templet: render_status},
                    {field: 'create_at', title: '创建日期', minWidth: 120, align: 'center', width: 200},
                    {field: 'release_date', title: '发布日期', minWidth: 120, align: 'center', width: 200},
                    {field: 'signed_users', title: '签章人员', minWidth: 120, align: 'center', width: 400},
                    {title: '操作', fixed: "right", toolbar: '#tools'}
                ];
                // 初始化筛选状态
                let local = layui.data('planVersionTable-filter');
                layui.each(arr, function (index, item){
                    if(item.field in local){
                        item.hide = local[item.field];
                    }
                });
                return arr;
            }()],
            done: function (){
                // 记录筛选状态
                let that = this;
                that.elem.next().on('mousedown', 'input[lay-filter="LAY_TABLE_TOOL_COLS"]+', function (){
                    let input = $(this).prev()[0];
                    layui.data('planVersionTable-filter', {
                        key: input.name,
                        value: input.checked
                    })
                });
            }

        });


        // 单元格工具事件（操作列的按钮组）
        table.on('tool(plan-version-table)', function (obj){
            const update = {}
            update.project_id = obj.data.project_id
            update.plan_version = obj.data.plan_version
            if (obj.event === 'tool-release') {  // 编辑
                layer.confirm('确认发布么？', function (){
                    update.status = "已发布"
                    planStatusUpdate(update)

                })
            } else if (obj.event === 'tool-cancel'){
                layer.confirm('确认撤销发布么？', function (){
                    update.status = "待提交"
                    planStatusUpdate(update)
                })
            } else if ( obj.event === 'tool-del') {  // 删除
                layer.confirm('确认删除么？', function (index) {
                    $.ajax({
                        url: `/api/v1/project/plan_version/${obj.data.id}`,
                        type: "DELETE",
                        contentType: "application/json",
                        success: function (res){
                            if (!res.code){
                                layer.msg(res.msg, {
                                    icon: 1,
                                    time: 1000
                                }, function(){
                                    table.reloadData('plan-version-table')
                                })
                            }
                        }
                    })
                    layer.close(index);
                });
            }
            /**
             * 根据项目id和项目版本和状态状态更改项目计划的状态
             * @param {Object} update - 更新对象
             * @param {number} update.project_id - 项目id
             * @param {number} update.plan_version - 计划版本
             * @param {String} update.status - 更改后的状态
             * returns
             */
            const planStatusUpdate = function (update) {
                $.ajax({
                    method: "PUT",
                    url: `/api/v1/project/plan_version/status_update`,
                    data: JSON.stringify(update),
                    contentType: "application/json",
                    success: function (res){
                        layer.msg(res.msg, {
                            icon: 1,
                            time: 1000
                        }, function(){
                            table.reloadData('plan-version-table')
                        })
                    },
                    error: function (res){
                        layer.msg(res.msg,{
                            icon: 2,
                            time: 1000
                        })
                    }
                })
            }
        });
    });

</script>
{% endblock %}