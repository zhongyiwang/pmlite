{% extends '_base.html' %}
{% block title %}项目管理{% endblock %}
{% block body %}
<!-- 项目表格 -->
<div class="layui-fluid">
    <!--项目列表-->
    <table class="layui-hide" id="project-table"></table>
</div>

<!--添加/编辑项目弹窗表单-->
<form class="layui-form" action="" id="project-form" lay-filter="project-form" style="margin-top: 20px; display: none">
    <div style="padding-right: 20px;">
        <div class="layui-form-item" style="display: none">
            <label class="layui-form-label">ID</label>
            <div class="layui-input-block">
                <input type="text" name="id" value="0" lay-verify="required" autocomplete="off" class="layui-input" disabled>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">客户名称</label>
            <div class="layui-input-block">
                <input type="text" name="customer" lay-verify="required" lay-affix="clear" autocomplete="off" placeholder="请输入客户名称"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">项目编号</label>
            <div class="layui-input-block">
                <input type="text" name="project_number" lay-verify="required" lay-affix="clear" class="layui-input" placeholder="请输入项目要编号">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">合同编号</label>
            <div class="layui-input-block">
                <input type="text" name="contract" lay-verify="required" lay-affix="clear" placeholder="请输入合同编号" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">机型</label>
            <div class="layui-input-block">
                <select name="machine_id" lay-verify="required" id="machine_id" lay-filter="machine_type_select">
                    <option value="">请选择机型</option>
                </select>
            </div>
        </div>



<!--?        <div class="layui-form-item">-->
<!--?            <label class="layui-form-label">自动线类型</label>-->
<!--?            <div class="layui-input-block">-->
<!--?                <select name="line_type" id="line_type">-->
<!--?                    <option value="default">未分类</option>-->
<!--?                    <option value="gl1">单机桁架</option>-->
<!--?                    <option value="gl2">一拖二桁架</option>-->
<!--?                    <option value="gl3">多台联机桁架</option>-->
<!--?                    <option value="robot1">固定机器人</option>-->
<!--?                    <option value="robot2">地轨机器人</option>-->
<!--?                    <option value="robot3">天轨机器人</option>-->
<!--?                </select>-->
<!--?            </div>-->
<!--?        </div>-->
<!--?        <div class="layui-form-item">-->
<!--?            <label class="layui-form-label">状态</label>-->
<!--?            <div class="layui-input-block">-->
<!--?                <select name="status">-->
<!--?                    <option value="未开始">未开始</option>-->
<!--?                    <option value="进行中">进行中</option>-->
<!--?                    <option value="已完成">已完成</option>-->
<!--?                </select>-->
<!--?            </div>-->
<!--?        </div>-->

        <div class="layui-form-item">
            <label class="layui-form-label">项目经理</label>
            <div class="layui-input-block">
                <select name="manager_id" lay-verify="required" id="manager_id" lay-filter="manager_id_select" class="user-select" lay-search="">
                    <option value="">请选择项目经理</option>
                </select>
            </div>
        </div>
<!--?        <div class="layui-form-item">-->
<!--?            <label class="layui-form-label">产品设计（机械）</label>-->
<!--?            <div class="layui-input-block">-->
<!--?                <select name="m_designer_id" id="m_designer_id" lay-filter="m_designer_id_select" class="user-select" lay-search="">-->
<!--?                    <option value="">请选择设计员</option>-->
<!--?                </select>-->
<!--?            </div>-->
<!--?        </div>-->
<!--?        <div class="layui-form-item">-->
<!--?            <label class="layui-form-label">产品设计（电气）</label>-->
<!--?            <div class="layui-input-block">-->
<!--?                <select name="e_designer_id" id="e_designer_id" lay-filter="e_designer_id_select" class="user-select" lay-search="">-->
<!--?                    <option value="">请选择设计员</option>-->
<!--?                </select>-->
<!--?            </div>-->
<!--?        </div>-->
        <div class="layui-form-item">
            <label class="layui-form-label">自动线</label>
            <div class="layui-input-block">
                <input type="radio" name="is_automation" value='true' title="是">
                <input type="radio" name="is_automation" value='false' title="否" checked>
            </div>
        </div>
<!--?        <div class="layui-form-item">-->
<!--?            <label class="layui-form-label">自动化设计</label>-->
<!--?            <div class="layui-input-block">-->
<!--?                <select name="am_designer_id" id="am_designer_id" lay-filter="am_designer_id_select" class="user-select" lay-search="">-->
<!--?                    <option value="">请选择设计员</option>-->
<!--?                </select>-->
<!--?            </div>-->
<!--?        </div>-->
<!--?        <div class="layui-form-item">-->
<!--?            <label class="layui-form-label">自动化设计（电气）</label>-->
<!--?            <div class="layui-input-block">-->
<!--?                <select name="ae_designer_id" id="ae_designer_id" lay-filter="ae_designer_id_select" class="user-select" lay-search="">-->
<!--?                    <option value="">请选择设计员</option>-->
<!--?                </select>-->
<!--?            </div>-->
<!--?        </div>-->

        <div class="layui-form-item" style="display: none">
            <label class="layui-form-label">生产部</label>
            <div class="layui-input-block">
                <input type="text" name="product_department" lay-affix="clear" class="layui-input" value="程振涛" placeholder="">
            </div>
        </div>
        <div class="layui-form-item" style="display: none">
            <label class="layui-form-label">营业部</label>
            <div class="layui-input-block">
                <input type="text" name="sales_department" lay-affix="clear" class="layui-input" value="岳建春" placeholder="">
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block">
<!--?                <button type="submit" class="layui-btn" lay-submit lay-filter="project-form-submit">提交</button>-->
                <button type="submit" class="layui-btn" lay-submit lay-filter="project-form-submit" lay-event="submit">提交审核</button>
                <button type="submit" class="layui-btn layui-btn-primary layui-border-green" lay-submit lay-filter="project-form-submit" lay-event="save">编辑暂存</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </div>
</form>

<!--项目详细（审核）弹窗-->
<form class="layui-form" id="project-info" lay-filter="project-info" style="margin-top: 20px; display: none">
    <div style="padding-right: 20px;">
        <div class="layui-form-item" style="display: none">
            <label class="layui-form-label">ID</label>
            <div class="layui-input-block">
                <input type="text" name="id" value="0" lay-verify="required" autocomplete="off" class="layui-input" disabled>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">客户名称</label>
            <div class="layui-input-block">
                <input type="text" name="customer" class="layui-input" disabled>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">项目编号</label>
            <div class="layui-input-block">
                <input type="text" name="project_number" class="layui-input" disabled>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">合同编号</label>
            <div class="layui-input-block">
                <input type="text" name="contract" class="layui-input" disabled>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">机型</label>
            <div class="layui-input-block">
                <input type="text" name="machine_type" class="layui-input" disabled>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">项目经理</label>
            <div class="layui-input-block">
                <input type="text" name="manager" class="layui-input" disabled>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">自动线</label>
            <div class="layui-input-block">
                <input type="text" name="is_automation" class="layui-input" disabled>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block" id="project-info-btn"></div>
        </div>
    </div>
</form>

<!-- 项目计划/实际修改弹窗 -->
<div id="project-plan-container" style="display: none; padding: 20px;">
    <table class="layui-hide" id="project-plan-table"></table>
</div>

<!--项目计划行双击弹窗-->
<div id="node-detail" style="display: none; padding: 20px">
    <div style="margin-bottom: 20px">
        <h3>请慎重操作，不可撤销。</h3>
    </div>
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm layui-btn-disabled" id="node-start-btn" disabled>确认开始</button>
        <button class="layui-btn layui-btn-sm layui-btn-warm layui-btn-disabled" id="node-end-btn" disabled>确认结束</button>
    </div>
</div>

<!-- 顶部工具栏（项目表） -->
<script type="text/html" id="toolbar">
    <div class="layui-btn-container" style="display: flex; align-items: center">
        <button class="layui-btn layui-btn-sm layui-btn-disabled" id="project-add-btn" lay-event="toolbar-add" disabled>添加项目</button>
        <button class="layui-btn layui-btn-sm layui-btn-primary" lay-event="toolbar-all">所有项目</button>
        <button class="layui-btn layui-btn-sm layui-btn-primary" lay-event="toolbar-mine">我的项目</button>
        <!-- 筛选开关 -->
        <form class="layui-form-item" style="display: inline-block; margin-left: 10px; margin-bottom: 10px;">
            <input type="checkbox" name="showAll" lay-skin="switch" lay-text="全部|未完成" lay-filter="showAllSwitch" id="showAllSwitch">
        </form>
    </div>
</script>

<!-- 项目计划表:顶部工具栏 -->
<script type="text/html" id="plan-table-toolbar">
    <div class="layui-btn-container" id="planTable-toolbar-container">
    </div>
</script>

<!-- 项目表： 右侧工具栏 -->
<script type="text/html" id="tools" >
    {% raw %}
    {{# if (d.status == "待提交"){ }}
        <!-- 待提交状态：显示编辑、显示删除 -->
        {{# if (d.manager_id == layui.data('pmlite').currentUserId) { }}
            <!-- 项目经理为当前用户的项目：允许编辑、允许删除 -->
            <button class="layui-btn layui-btn-xs layui-btn-primary layui-border-green" lay-event="tool-edit">编辑</button>
            <button class="layui-btn layui-btn-xs layui-btn-primary layui-border-red" lay-event="tool-del">删除</button>
        {{# } else { }}
            <!-- 项目经理非当前用户的项目：不允许编辑、不允许删除 -->
            <button class="layui-btn layui-btn-xs layui-btn-primary layui-border-green layui-btn-disabled" lay-event="tool-edit" disabled>编辑</button>
            <button class="layui-btn layui-btn-xs layui-btn-primary layui-border-red layui-btn-disabled" lay-event="tool-del" disabled>删除</button>
        {{# } }}
        <button class="layui-btn layui-btn-xs layui-btn-primary layui-btn-disabled layui-border-blue" lay-event="tool-edit-plan" disabled>项目计划</button>
    {{# } else if (d.status == "已提交") { }}
        <button class="layui-btn layui-btn-xs layui-btn-primary layui-border-green" lay-event="tool-info">详细</button>
        <button class="layui-btn layui-btn-xs layui-btn-primary layui-btn-disabled layui-border-red" lay-event="tool-del" disabled>删除</button>
        <button class="layui-btn layui-btn-xs layui-btn-primary layui-border-blue layui-btn-disabled" lay-event="tool-edit-plan" disabled>项目计划</button>
    {{# } else { }}
        <!-- 已审核状态 -->
        <button class="layui-btn layui-btn-xs layui-btn-primary layui-border-green" lay-event="tool-info">详细</button>
        <button class="layui-btn layui-btn-xs layui-btn-primary layui-btn-disabled layui-border-red" lay-event="tool-del" disabled>删除</button>
        <button class="layui-btn layui-btn-xs layui-btn-primary layui-border-blue" lay-event="tool-edit-plan">项目计划</button>
    {{# } }}

<!--?    {{# if (!d.is_released) { }}-->
<!--?    <button class="layui-btn layui-btn-xs layui-btn-primary layui-border-blue" lay-event="tool-edit-plan">项目计划</button>-->
<!--?    {{# }else{ }}-->
<!--?    <button class="layui-btn layui-btn-xs layui-btn-warm" lay-event="tool-edit-plan">填写实际</button>-->
<!--?    {{# } }}-->
<!--?    <button class="layui-btn layui-btn-xs" lay-event="more">-->
<!--?        更多-->
<!--?        <i class="layui-icon layui-icon-down"></i>-->
<!--?    </button>-->
    {% endraw %}

</script>



<script>
    // 更改 禁用 列的渲染
    function render_status(d) {
        const statusMap = {
            '待提交': '<span class="layui-badge layui-bg-gray">待提交</span>',
            '已提交': '<span class="layui-badge layui-bg-blue">已提交</span>',
            '已审核': '<span class="layui-badge layui-bg-green">已登录</span>',
            '执行中': '<span class="layui-badge layui-bg-orange">执行中</span>',
            '已完成': '<span class="layui-badge layui-bg-red">已完成</span>'
        };
        return statusMap[d.status] || d.status;
    }

    // 更改 自动化 列的渲染
    function render_automation(d) {
        if (d.is_automation) {
            return '自动化'
        } else {
            return '否'
        }
    }

    function render_contract(d){
        const value = d.contract || ""
        if(value.includes(',')){
            return value.split(',').join('<br>')
        } else {
            return value
        }
    }



    // 获取登录时保存的用户id
    const user_id = localStorage.getItem('user_id')

    layui.use(['pmlite', 'auth'], function () {
        var table = layui.table;
        let treeTable = layui.treeTable;
        var $ = layui.$;
        var form = layui.form;
        var layer = layui.layer;
        let laydate = layui.laydate;
        let dropdown = layui.dropdown;
        let util = layui.util;
        let element = layui.element;
        let pmlite = layui.pmlite;
        const auth = layui.auth;

        // 给默认的ajax请求添加权限
        $.ajaxSetup({
            headers: {
                // Authorization: "Bearer " + localStorage.getItem("access_token")
                Authorization: "Bearer " + layui.data("system").jwt_access_token
            }
        })

        // 根据权限，设置【添加项目】按钮的状态（禁用->可用）
        function setProjectToolbarBtns(){
            if (auth.hasPermission('project_create')){
                $("#project-add-btn")
                        .removeClass('layui-btn-disabled')
                        .removeAttr('disabled')
            }
        }

        // 日期选择框渲染
        laydate.render({
            elem: '.date-input'
        })


        // 默认获取项目的url
        let baseUrl = '/api/v1/project'
        let url = baseUrl

        // 从本地缓存中读取是否显示全部任务的状态，修改相应的请求url
        if (layui.data('project').projectShowAll) {
            url += '?showAll=1'
        }
        form.render('checkbox')

        // 渲染项目表格
        table.render({
            elem: '#project-table',
            id: 'project-table',
            url: url,
            toolbar: '#toolbar',
            page: true,
            limit: 30,
            height: 'full-15',
            css: [ // 设置单元格样式
                  // 取消默认的溢出隐藏，并设置适当高度
                  '.layui-table-cell{height: 50px; line-height: 40px;}',
                  '.layui-table-cell .layui-colorpicker{width: 38px; height: 38px;}',
                  '.layui-table-cell select{height: 36px; padding: 0 5px;}'
                ].join(''),
            cols: [
                    [
                        {field: 'id', title: 'ID', width:50, align: 'center', rowspan: 2, hide:true, fixed: "left"},
                        {field: 'customer', title: '客户名称 <i class="layui-icon layui-icon-search layui-font-14" lay-event="customer-filter" title="" le="margin-left: 5px;"></i>', minWidth:200, align: 'center', fixed: "left"},
                        {field: 'contract', title: '合同编号', minWidth:160, align: 'center', templet: render_contract},
                        {field: 'project_number', title: '项目编号', minWidth:110, align: 'center', sort: true},
                        {field: 'machine_type', title: '机型', minWidth:120, align: 'center'},
                        {field: 'is_automation', title: '自动化', minWidth:80, align: 'center', templet: render_automation},
                        {field: 'manager', title: '项目经理', minWidth:90, align: 'center'},
                        {field: 'status', title: '项目状态', minWidth:90, align: 'center', templet: render_status},
                        {field: 'current_stage', title: '当前阶段', minWidth:90, align: 'center'},
                        {title: '操作', fixed: "right", minWidth:200, align:"center", toolbar: '#tools'}

                    ]
                ],
            done: function (res, curr, count){
                let options = this;
                // 获取当前行数据 - 自定义方法
                table.getRowData = function(tableId, elem){
                    let index = $(elem).closest('tr').data('index');
                    return table.cache[tableId][index] || {};
                };
                // 展示数据 - 仅用于演示
                let showData = function(data) {
                    return layer.msg('当前行最新数据：<br>'+ util.escape(JSON.stringify(data)), {
                      offset: '16px',
                      anim: 'slideDown'
                    });
                };

                // 修改数据库数据（根据id和更新的字段）
                let updateData = function(id, update){
                    url = '/api/v1/project/' + id;

                    $.ajax({
                        method: "PUT",
                        url: url,
                        data: JSON.stringify(update),
                        contentType: "application/json",
                        //datatype: "json",
                        success: function (res){
                            layer.msg(res.msg, {
                                icon: 1,
                                time: 1000
                            }, function(){
                                // layer.closeAll('page');
                                table.reloadData('project-table', {
                                    scrollPos: 'fixed'
                                })
                            })
                        },
                        error: function (res){
                            layer.msg(res.msg,{
                                icon: 2,
                                time: 1000
                            })
                        }
                    })
                };

                // 根据权限，设置【添加项目】按钮的状态（禁用->可用）
                setProjectToolbarBtns()

                // 单元格编辑事件
                table.on('edit(project-table)', function (obj) {
                    console.log(obj.event)
                    let value = obj.value // 得到修改后的值
                    let data = obj.data // 得到所在行所有键值
                    let field = obj.field; // 得到字段名
                    let update = {};
                    update[field] = value;

                    updateData(data.id, update);  // 更新服务器数据
                });

                // 单元格工具事件（双击，暂时不用）
                table.on('toolDouble(project-table)', function (obj){
                    // let data = obj.data;  // 得到所在行所有键值
                    let id = obj.data.id;  // 得到所在行的id
                    let field = $(this).data('field');  // 得到字段名
                    let update = {};
                    switch (obj.event) {
                        case "date":  // 所有日期类型单元格的处理
                            laydate.render({
                                elem: this.firstChild,  // 固定写法
                                show: true,  // 直接显示
                                done: function (value, date){
                                    update[field] = value;
                                    updateData(id, update);  // 更新服务器数据
                                }
                            })
                            break
                        case "status-dropdown":  // 完成状态的下拉菜单处理
                            dropdown.render({
                                elem: this.firstChild,  // 固定写法
                                show: true,  // 直接显示
                                data: [{
                                    title: '未开始',
                                    id: 100
                                },{
                                    title: '进行中',
                                    id: 101
                                },{
                                    title: '已完成',
                                    id: 102
                                }],
                                click: function (data) {
                                    update[field] = data.title
                                    this.elem.text(data.title)  // 直接更改网页的显示
                                    updateData(id, update);  // 更新服务器数据
                                }
                            });
                            break;
                        case "get-user":
                            // let offset = $(this).offset()
                            // console.log(offset)
                            layer.open({
                                type: 1, // page 层类型
                                area: ['300px', '400px'],
                                // offset: ['253px', '1000px'],
                                title: false,
                                shadeClose: true, // 点击遮罩区域，关闭弹层
                                // maxmin: true, // 允许全屏最小化
                                // 注: 这里特别对 select 设置了 lay-append-position 属性，以便与 layer 的定位方式保持一致
                                content: '<form class="layui-form layui-padding-3" lay-filter="test"><select lay-append-to="body" lay-append-position="fixed"><option value="">请选择</option><option value="AAA1">选项 A1</option><option value="AAA2">选项 A2</option><option value="AAA3">选项 A3</option><option value="AAA4">选项 A4</option><option value="AAA5">选项 A5</option><option value="AAA6">选项 A6</option><option value="AAA7">选项 A7</option><option value="AAA8">选项 A8</option><option value="AAA9">选项 A9</option><option value="AAA10">选项 A10</option><option value="AAA11">选项 A11</option><option value="AAA12">选项 A12</option><option value="BBB">选项 B</option><option value="CCC">选项 C</option></select></form>',
                                success: function (layero) {
                                    // 定向渲染 select
                                    form.render(layero.find('.layui-form select'));
                                    // 鼠标滑动 layer 内部滚动条时移除下拉框，以规避错位
                                    // 若 layer 内部不存在滚动条，以下代码可删除
                                    var selectElem = layero.find('.layui-form-select');
                                    layero.find('.layui-layer-content').on('scroll', function () {
                                        selectElem.removeClass('layui-form-selected');
                                        layui.$('.layui-select-panel-wrap').detach();
                                    });
                                }
                            });
                    }

                })

                initShowAllSwitch()
                // 初始化显示全部开关状态（在表格渲染完成后调用）
                function initShowAllSwitch(){
                    const showAllSwitch = $('#showAllSwitch')

                    if (showAllSwitch.length) {
                        // console.log('状态', showAllSwitch.prop('checked'))
                        if (layui.data('project').projectShowAll) {
                            showAllSwitch.prop('checked', true)
                        }
                    } else {
                        setTimeout(initShowAllSwitch, 100)
                    }
                }

                element.render()  // table渲染完成后，渲染进度条。否则进度条不显示。
            }

        });

        // 获取机型列表，并渲染
        const get_machine_types = function (obj) {
            $.ajax({
                url: "/api/v1/machine",
                type: "get",
                async: false,
                success: function (res) {
                    let content = '<option value="">请选择机型</option>'
                    //console.log(res.data)
                    $.each(res.data, function (i, val) {
                        if (obj && val.name === obj.data.machine_type) {
                            content += '<option value="' + val.id + '" selected>' + val.name + '</option>'
                        } else {
                            content += '<option value="' + val.id + '">' + val.name + '</option>'
                        }
                    })
                    // console.log(content)
                    let s = $('#machine_id')
                    s.html(content)
                    //console.log(s.html())
                    form.render('select')
                }
            })
        }

        // 表头自定义元素工具事件 --- 2.8.8+
        table.on('colTool(project-table)', function (obj) {
            switch (obj.event) {
                case "customer-filter":  // 客户查询
                    layer.prompt({title: '请输入文本'}, function (value, index, elem) {
                        if (value === '') return elem.focus();
                        let input = util.escape(value)
                        let newUrl = ''
                        if (layui.data('project').projectShowAll) {
                            newUrl = baseUrl + '?showAll=1&customer=' + input
                        } else {
                            newUrl = baseUrl + '?customer=' + input
                        }
                        table.reloadData('project-table', {
                            url: newUrl
                        })
                        layer.close(index);
                    });
                    break
                case "manager-filter":  // 项目经理查询
                    layer.prompt({title: '请输入文本'}, function (value, index, elem) {
                        if (value === '') return elem.focus();
                        let input = util.escape(value)
                        let newUrl = ''
                        if (layui.data('project').projectShowAll) {
                            newUrl = baseUrl + '?showAll=1&manager=' + input
                        } else {
                            newUrl = baseUrl + '?manager=' + input
                        }
                        table.reload('project-table', {
                            url: newUrl
                        })
                        layer.close(index);
                    });
                    break
                case "sales-manager-filter":  // 项目经理查询
                    layer.prompt({title: '请输入文本'}, function (value, index, elem) {
                        if (value === '') return elem.focus();
                        let input = util.escape(value)
                        let newUrl = ''
                        if (layui.data('project').projectShowAll) {
                            newUrl = baseUrl + '?showAll=1&sales_manager=' + input
                        } else {
                            newUrl = baseUrl + '?sales_manager=' + input
                        }
                        table.reload('project-table', {
                            url: newUrl
                        })
                        layer.close(index);
                    });
                    break
            }
        });

        // 项目表：顶部工具栏事件
        table.on('toolbar(project-table)', function (obj){
            let options = obj.config;  //获取当前表格属性配置项

            // 根据不同的事件名进行相应的操作
            switch (obj.event){  // 对应模板元素中的 lay-event 属性值
                case 'toolbar-add':
                    $("#project-form")[0].reset();  // 将ID表单清空
                    layer.open({
                        type: 1,
                        title: "项目信息",
                        shade: false,
                        content: $("#project-form"),
                        area: ["600px", "450px"]
                    })
                    get_machine_types()  // 获取机型，并渲染select
                    // 获取用户列表，并渲染
                    pmlite.getUsers('manager_id', undefined, 'owner', true)
                    // pmlite.getUsers('manager_id')
                    // pmlite.getUsers('m_designer_id')
                    // pmlite.getUsers('e_designer_id')
                    // pmlite.getUsers('am_designer_id')
                    // pmlite.getUsers('ae_designer_id')
                    break;
                case 'toolbar-all':
                    // 表格重载
                    table.reloadData('project-table', {
                        url: url
                    })

                case 'toolbar-mine':
                    // 根据url中是否包含查询字符串？，组合新的查询url
                    let newUrl = ""
                    if (url.includes('?')) {
                        newUrl = url + '&mine=1'
                    } else {
                        newUrl = url + '?mine=1'
                    }
                    // 表格重载
                    table.reloadData('project-table', {
                        url: newUrl
                    })
                    break
            }
        })

        // 单元格工具事件（操作列的按钮组）
        table.on('tool(project-table)', function (obj) {

            const currentProject = obj.data
            console.log('当前项目：', currentProject)
            const project_id = obj.data.id
            let plan_version = obj.data.plan_version
            // const planStatus = obj.data.plan_status
            if (obj.event === 'tool-edit') {  // 编辑项目基本信息
                form.val('project-form', obj.data);

                // 自动线类型select选项的渲染
                $("#line_type option:contains('" + obj.data.line_type + "')").prop('selected', true)
                get_machine_types(obj)

                // 获取用户列表，并渲染
                pmlite.getUsers('manager_id', obj, 'manager')
                pmlite.getUsers('m_designer_id', obj, 'm_designer')
                pmlite.getUsers('e_designer_id', obj, 'e_designer')
                pmlite.getUsers('am_designer_id', obj, 'am_designer')
                pmlite.getUsers('ae_designer_id', obj, 'ae_designer')

                layer.open({
                    type: 1,
                    title: '项目信息',
                    area: ['600px', '450px'],
                    content: $('#project-form'),  // 捕获的元素
                });
            } else if (obj.event === 'tool-info'){  // 项目评审
                // 将is_automation字段渲染为汉字
                if (obj.data['is_automation']) {
                    obj.data['is_automation'] = '是'
                } else {
                    obj.data['is_automation'] = '否'
                }

                form.val('project-info', obj.data);
                console.log(obj.data)

                // 当前用户为项目管理员的话，添加按钮
                if (auth.hasPermission('project_admin')) {
                    const $target = $('#project-info-btn');

                    // 如果项目已提交，则显示【审核通过】【退回编辑】2个按钮，否则只显示【退回编辑】1个按钮
                    let btns = ''
                    if (obj.data['status'] === '已提交') {
                        btns = `
                            <button type="submit" class="layui-btn" lay-submit lay-filter="project-info-submit" lay-event="approve">审核通过</button>
                            <button type="submit" class="layui-btn layui-btn-danger" lay-submit lay-filter="project-info-submit" lay-event="reject">退回编辑</button>
                        `
                    } else {
                        btns = `
                            <button type="submit" class="layui-btn layui-btn-danger" lay-submit lay-filter="project-info-submit" lay-event="reject">退回编辑</button>
                        `
                    }
                    // 将按钮子元素清空，防止重复显示
                    $target.empty()
                    // 添加按钮
                    $target.append(btns)


                }
                layer.open({
                    type: 1,
                    title: '项目信息',
                    area: '600px',
                    content: $('#project-info'),  // 捕获的元素
                });

            } else if (obj.event === 'tool-edit-plan'){
                // 常量：
                const isPlanReleased= obj.data.is_released


                // 【有无】列渲染
                function render_is_used(d){
                    if (d.is_used){
                        return "有"
                    } else {
                        return "无"
                    }
                }

                // 【拖期天数】列渲染
                function render_name(d){
                    if (d.delay_days > 0) {
                        return '<span style="color: #ff4d4f; font-weight: bold;">' + d.name + '</span>'
                    } else {
                        return '<span>' + d.name + '</span>';
                    }
                }

                // 【拖期天数】列渲染
                function render_delay_days(d){
                    if (d.delay_days > 0) {
                        return '<span style="color: #ff4d4f; font-weight: bold;">' + d.delay_days + '</span>'
                    } else {
                        return '<span>' + d.delay_days + '</span>';
                    }
                }

                // 修改数据库数据（根据id和更新的字段）
                const updateNodeData = function (id, update) {
                    url = '/api/v1/project/node/' + id;

                    $.ajax({
                        method: "PUT",
                        url: url,
                        data: JSON.stringify(update),
                        contentType: "application/json",
                        //datatype: "json",
                        success: function (res) {
                            layer.msg(res.msg, {
                                icon: 1,
                                time: 1000
                            }, function () {
                                // layer.closeAll('page');
                                treeTable.reloadData('project-plan-table', {
                                    scrollPos: 'fixed',
                                })
                            })
                        },
                        error: function (res) {
                            layer.msg(res.msg, {
                                icon: 2,
                                time: 1000
                            })
                        }
                    })
                };

                // 弹出项目详情页面
                layer.open({
                    type: 1,
                    title: false,
                    //title: `${obj.data.customer}`,
                    offset: 'r',
                    anim: 'slideLeft',
                    area: ['90%', '100%'],
                    shadeClose: true,
                    content: $('#project-plan-container'),
                    closeBtn: 0
                })

                let cols = [[
                        {type: 'checkbox', fixed: 'left', rowspan: 2},
                        {field: 'id', title: 'ID', width: 50, align: 'center', rowspan: 2, hide: true},
                        {field: 'node_id', title: '序号', width: 50, align: 'center', rowspan: 2},
                        {field: 'name', title: '项目节点', width: 320, rowspan: 2, templet: render_name},
                        {field: 'is_used', title: '有无', width: 80, align: 'center', rowspan: 2, templet: render_is_used},
                        {field: 'manager', title: '负责人', width: 160, align: 'center', rowspan: 2, event:'manager_select'},
                        {title: '计划日期', width: 360, align: "center", colspan: 3},
                        {title: '实际日期', width: 360, align: "center", colspan: 3},
                        {field: 'remark', title: '备注', width: 300, align: 'center', edit: 'text', rowspan: 2},
                    ], [
                        {field: 'planned_start_date', title: '计划开始', width: 110, align: 'center', event: 'date'},
                        {field: 'planned_end_date', title: '计划结束', width: 110, align: 'center', event: 'date'},
                        {field: 'planned_period', title: '计划周期', width: 110, align: 'center'},
                        {field: 'actual_start_date', title: '实际开始', width: 110, align: 'center'},
                        {field: 'actual_end_date', title: '实际结束', width: 110, align: 'center'},
                        {field: 'delay_days', title: '拖期天数', width: 110, align: 'center', templet: render_delay_days},
                    ]]

                let planVersion = 0
                let planStatus = ""

                // 渲染项目计划表格
                treeTable.render({
                    elem: '#project-plan-table',
                    id: 'project-plan-table',
                    //url: `/api/v1/project/${project_id}/node?version=${plan_version}`,
                    url: `/api/v1/project/${project_id}/plan/${plan_version}`,
                    toolbar: '#plan-table-toolbar',
                    // page: true,
                    // limit: 30,
                    height: 'full-50',
                    css: [ // 设置单元格样式
                        // 取消默认的溢出隐藏，并设置适当高度
                        '.layui-table-cell{height: 50px; line-height: 40px;}',
                        '.layui-table-cell .layui-colorpicker{width: 38px; height: 38px;}',
                        '.layui-table-cell select{height: 36px; padding: 0 5px;}'
                    ].join(''),
                    cols: cols,
                    tree: {
                        view: {
                            'expandAllDefault': true,  // 默认展开全部节点，默认为false
                            'dblClickExpand': false
                        }
                    },
                    done: function (res, curr, count) {
                        // 每次渲染计划表格时，更新计划版本即版本状态
                        planVersion = res.plan_version
                        planStatus = res.plan_status
                        console.log(`计划版本：${planVersion}, 版本状态：${planStatus}`)
                        console.log('当前项目：', currentProject)
                        if (planStatus === "已提交" || planStatus === "已发布") {
                            // 隐藏表头的 checkbox
                            $('.layui-table-header [data-field="0"]').hide();
                            // 隐藏所有行的 checkbox
                            $('.layui-table-body [data-field="0"]').hide();
                            // 调整第一列宽度（可选，避免空白）
                            $('.layui-table th:first-child, .layui-table td:first-child').css('width', '0');
                        }

                        const id = this.id;
                        let options = this;
                        // 获取当前行数据 - 自定义方法
                        table.getRowData = function (tableId, elem) {
                            let index = $(elem).closest('tr').data('index');
                            return table.cache[tableId][index] || {};
                            console.log(table.cache[tableId][index] || {});

                        };
                        // 展示数据 - 仅用于演示
                        let showData = function (data) {
                            return layer.msg('当前行最新数据：<br>' + util.escape(JSON.stringify(data)), {
                                offset: '16px',
                                anim: 'slideDown'
                            });
                        };

                        // 项目计划表：动态渲染toolbar
                        const renderToolbar = function () {
                            let planCreateBtn = ''
                            let setUseBtn = ''
                            let auditBtn = ''
                            let adminBtn = ''
                            let statusBadge = ''
                            // 可以创建项目计划的条件
                            // 1. 当前没有项目计划版本
                            // 2. 当前登录用于为该项目负责人
                            if (planVersion === 0 && auth.getUserInfo().id === currentProject.manager_id) {
                                planCreateBtn = '<button id="plan-add-btn" class="layui-btn layui-btn-sm layui-btn-primary" lay-event="plan_create">添加计划</button>'
                            } else {
                                planCreateBtn = '<button id="plan-add-btn" class="layui-btn layui-btn-sm layui-btn-primary layui-btn-disabled" lay-event="plan_create" disabled>添加计划</button>'
                            }
                            if (planVersion > 0 && planStatus == "待提交" && auth.getUserInfo().id === currentProject.manager_id) {
                                setUseBtn = '<button class="layui-btn layui-btn-sm layui-btn-primary" lay-event="toolbar-set-use">有无设置</button>'
                                auditBtn = '<button class="layui-btn layui-btn-sm layui-btn-primary" lay-event="toolbar-audit">提交审核</button>'
                            } else {
                                setUseBtn = '<button class="layui-btn layui-btn-sm layui-btn-primary layui-btn-disabled" lay-event="toolbar-set-use" disabled>有无设置</button>'
                                auditBtn = '<button class="layui-btn layui-btn-sm layui-btn-primary layui-btn-disabled" lay-event="toolbar-audit" disabled>提交审核</button>'
                            }
                            if (auth.hasPermission('project_admin')) {
                                if (planStatus === "已提交") {
                                    adminBtn = '<button class="layui-btn layui-btn-sm layui-btn-primary" lay-event="toolbar-plan-approve">审核通过</button>' +
                                        '<button class="layui-btn layui-btn-sm layui-btn-primary" lay-event="toolbar-plan-reject">退回编辑</button>'
                                } else {
                                    adminBtn = '<button class="layui-btn layui-btn-sm layui-btn-primary layui-btn-disabled" lay-event="toolbar-plan-approve" disabled>审核通过</button>' +
                                        '<button class="layui-btn layui-btn-sm layui-btn-primary layui-btn-disabled" lay-event="toolbar-plan-reject" disabled>退回编辑</button>'
                                }

                            }
                            if (planVersion != 0 && planStatus === '待提交') {
                                statusBadge = '<span class="layui-badge layui-bg-blue">待提交</span>'
                            } else if (planVersion != 0 && planStatus === "已提交") {
                                statusBadge = '<span class="layui-badge layui-bg-orange">已提交</span>'
                            } else if (planVersion != 0 && planStatus === '已发布') {
                                statusBadge = '<span class="layui-badge layui-bg-gree">已发布</span>'
                            }

                            // if (isPlanReleased) {
                            //     html = '<button id="plan-add-btn" class="layui-btn layui-btn-sm layui-btn-primary layui-btn-disabled" lay-event="plan_create" disabled>添加计划</button>' +
                            //             '<button class="layui-btn layui-btn-sm layui-btn-primary layui-btn-disabled" lay-event="toolbar-set-use" disabled>有无设置</button>'
                            // } else {
                            //     html = '<button id="plan-add-btn" class="layui-btn layui-btn-sm layui-btn-primary" lay-event="plan_create">添加计划</button>' +
                            //             '<button class="layui-btn layui-btn-sm layui-btn-primary" lay-event="toolbar-set-use">有无设置</button>'
                            // }
                            $("#planTable-toolbar-container").html(planCreateBtn + setUseBtn + auditBtn + adminBtn + statusBadge)
                        }

                        renderToolbar()

                        // 版本显示
                        dropdown.render({
                            elem: '#rowMode',
                            data: [{
                                id: 1,
                                title: '1'
                            },{
                                id: 2,
                                title: '2'
                            }],
                            //菜单被点击的事件
                            click: function (obj) {
                                var checkStatus = table.checkStatus(id)
                                var data = checkStatus.data

                            }
                        })

                        // 修改数据库数据（根据id和更新的字段）
                        let updateData = function (id, update) {
                            console.log(id, update)
                            url = '/api/v1/project/node/' + id;

                            $.ajax({
                                method: "PUT",
                                url: url,
                                data: JSON.stringify(update),
                                contentType: "application/json",
                                //datatype: "json",
                                success: function (res) {
                                    layer.msg(res.msg, {
                                        icon: 1,
                                        time: 1000
                                    }, function () {
                                        // layer.closeAll('page');
                                        treeTable.reloadData('project-plan-table', {
                                            scrollPos: 'fixed',
                                        })
                                    })
                                },
                                error: function (res) {
                                    layer.msg(res.msg, {
                                        icon: 2,
                                        time: 1000
                                    })
                                }
                            })
                        };


                        // 单元格编辑事件
                        table.on('edit(project-plan-table)', function (obj) {
                            console.log(obj)
                            let value = obj.value // 得到修改后的值
                            let data = obj.data // 得到所在行所有键值
                            let field = obj.field; // 得到字段名
                            let update = {};
                            update.update = {}
                            update.field = field
                            update.value = value
                            update.update[field] = value;

                            updateData(data.id, update);  // 更新服务器数据
                            // updateData(data.id, data);  // 更新服务器数据
                        });

                        // 单元格工具事件，对应表头中的event事件
                        table.on('tool(project-plan-table)', function (obj) {
                            // 当满足以下条件时，不触发单元格编辑
                            // 1. 当前登录用户不是项目经理
                            // 2. 计划处于非【待提交】状态
                            // 3. 单机行为父节点
                            // 4. 该节点没使用
                            if (auth.getUserInfo().id != currentProject.manager_id || planStatus != "待提交"  || obj.data.isParent || !obj.data.is_used) {
                                return
                            }

                            // 非【待提交】状态，不触发单元格编辑
                            // if (planStatus != "待提交") {
                            //     return
                            // }

                            // 定义event事件的触发权限
                            // 如果点击的当前行为父节点，不触发任何操作
                            // if (obj.data.isParent){
                            //     return
                            // }
                            // 如何当前计划已经发布，不触发任何操作
                            // if (obj.data.isParent || layui.data('project').plan_is_released) {
                            //     return;
                            // }

                            let id = obj.data.id;  // 得到所在行的id
                            let field = $(this).data('field');  // 得到字段名
                            let update = {};
                            update.update = {}
                            switch (obj.event) {
                                case "date":  // 所有日期类型单元格的处理
                                    laydate.render({
                                        elem: this.firstChild,  // 固定写法
                                        show: true,  // 直接显示
                                        done: function (value, date) {
                                            update.field = field
                                            update.value = value
                                            update.update[field] = value;
                                            updateData(id, update);  // 更新服务器数据
                                        }
                                    })
                                    break
                                case "manager_select":
                                    layer.open({
                                        type: 1, // page 层类型
                                        area: ['300px', '370px'],
                                        // offset: ['253px', '1000px'],
                                        title: false,
                                        shadeClose: true, // 点击遮罩区域，关闭弹层
                                        // maxmin: true, // 允许全屏最小化
                                        // 注: 这里特别对 select 设置了 lay-append-position 属性，以便与 layer 的定位方式保持一致
                                        content: '<form class="layui-form layui-padding-3"><select lay-append-to="body" lay-append-position="fixed" lay-search="{fuzzy: true}" id="manager-select" lay-filter="manager-select"><option value="">请选择</option></select></form>',
                                        success: function (layero) {
                                            // 定向渲染 select
                                            form.render(layero.find('.layui-form select'));
                                            $.ajax({
                                                url: "/api/v1/user",
                                                type: "get",
                                                async: false,
                                                success: function (res) {
                                                    let content = "<option value=''>请选择</option>"
                                                    $.each(res.data, function (i, val) {
                                                        if (obj && val.name === obj.data.manager) {
                                                            content += '<option value="' + val.id + '" selected>' + val.name + '</option>'
                                                        } else {
                                                            content += '<option value="' + val.id + '">' + val.name + '</option>'
                                                        }
                                                    })
                                                    let s = $('#manager-select')
                                                    s.html(content)
                                                    form.render('select')
                                                }
                                            })
                                        }
                                    });
                                    form.on('select(manager-select)', function (data) {
                                        update.field = field
                                        update.update.manager_id = data.value
                                        // console.log(id, update)
                                        updateData(id,update)  // 更新服务器数据
                                        layer.closeLast()
                                    })
                                    break;
                            }

                        })
                    }

                });

                // 顶部工具栏事件（项目计划）
                treeTable.on('toolbar(project-plan-table)', function (obj){
                    let options = obj.config;  //获取当前表格属性配置项
                    // 根据不同的事件名进行相应的操作
                    switch (obj.event){  // 对应模板元素中的 lay-event 属性值
                        case 'plan_create':
                            // 项目计划表：添加计划按钮事件
                            $.ajax({
                                method: 'POST',
                                url: `/api/v1/project/${project_id}/initial_plan_create`,
                                // data: JSON.stringify(update),
                                contentType: "application/json",
                                success: function (res){
                                    console.log(res)
                                    layer.msg(res.msg, {
                                        icon: 1,
                                        time: 1000
                                    }, function(){
                                        // layer.closeAll('page');
                                        table.reload('project-table')
                                        // 使用新的版本号，重新载入项目计划表格
                                        treeTable.reload('project-plan-table', {
                                            url: `/api/v1/project/${project_id}/plan/${res.plan_version}`
                                        })

                                    })
                                },
                                error: function (res){
                                    console.log(res)
                                    layer.msg(res.msg,{
                                        icon: 2,
                                        time: 1000
                                    })
                                }
                            })
                            break;
                        case 'toolbar-set-use':
                            // 项目计划表：设置有无按钮事件
                            const tableId = obj.config.id;
                            const status = treeTable.checkStatus(tableId)
                            if (!status.data.length) return layer.msg('无选中数据');
                            const selectIds = status.data.map(item => item.id)
                            let update = {
                                "ids": selectIds,
                                'is_used': false
                            }
                            layer.alert('设置选中节点是否使用？',{
                                btn: ['使用', '不使用'],
                                btnAlign: 'c', // 按钮居中
                                btn1: function (){
                                    update.is_used = true
                                    console.log(update)
                                    updateNode(update)
                                },
                                btn2: function (){
                                    updateNode(update)
                                }
                            })

                            // 更新数据库
                            const updateNode = function (update) {
                                $.ajax({
                                    method: 'POST',
                                    url: '/api/v1/project/node/set-use',
                                    data: JSON.stringify(update),
                                    contentType: "application/json",
                                    success: function (res){
                                        console.log(res)
                                        layer.msg(res.msg, {
                                            icon: 1,
                                            time: 1000
                                        }, function(){
                                            // layer.closeAll('page');
                                            treeTable.reloadData('project-plan-table', {
                                                scrollPos: 'fixed'
                                            })
                                        })
                                    },
                                    error: function (res){
                                        console.log(res)
                                        layer.msg(res.msg,{
                                            icon: 2,
                                            time: 1000
                                        })
                                    }
                                })
                            }
                            break;
                        case "toolbar-audit": {
                            // 项目计划表：提交审核按钮事件
                            let update = {}
                            update.project_id = project_id
                            update.plan_version = planVersion
                            update.status = "已提交"
                            $.ajax({
                                method: 'PUT',
                                url: '/api/v1/project/plan_version/status_update',
                                data: JSON.stringify(update),
                                contentType: "application/json",
                                success: function (res) {
                                    console.log(res)
                                    layer.msg(res.msg, {
                                        icon: 1,
                                        time: 1000
                                    }, function () {
                                        // layer.closeAll('page');
                                        table.reload('project-table')
                                        treeTable.reload('project-plan-table', {
                                            scrollPos: 'fixed'
                                        })
                                    })
                                },
                                error: function (res) {
                                    console.log(res)
                                    layer.msg(res.msg, {
                                        icon: 2,
                                        time: 1000
                                    })
                                }
                            })
                            break;
                        }
                        case "toolbar-plan-approve": {
                            // 项目计划表：审核通过按钮事件
                            planStatusUpdate({
                                project_id: currentProject.id,
                                plan_version: planVersion,
                                status: '已发布'
                            })
                            break;
                        }
                        case "toolbar-plan-reject": {
                            // 项目计划表：退回编辑按钮事件
                            planStatusUpdate({
                                project_id: currentProject.id,
                                plan_version: planVersion,
                                status: '待提交'
                            })
                            break;
                        }
                    }
                })

                // 行双击事件（确认实际的开始、结束日期）
                treeTable.on('rowDouble(project-plan-table)', function (obj){
                    console.log(obj)
                    // 该行可双击的条件：
                    // 1. 不是父节点
                    // 2. 使用该节点
                    // 3. 该节点有计划开始和计划结束
                    // 4. 项目计划已发布
                    // if (!obj.data.isParent && obj.data.is_used && planStatus === "已发布") {
                    if (!obj.data.isParent && obj.data.is_used && obj.data.planned_start_date && obj.data.planned_end_date && planStatus === "已发布") {
                        layer.open({
                            type: 1,
                            title: '节点信息',
                            content: $('#node-detail'),
                            area: '800px',
                            shadeClose: true,
                            success: function (layero, index){
                                // 获取弹窗内的按钮元素
                                const $startBtn = layero.find('#node-start-btn')
                                const $endBtn = layero.find('#node-end-btn')
                                // 根据条件设置按钮的可点击状态（禁用->可用）

                                // 当没有实际开始日期，并且有disabled属性时，取消属性，【确认开始】按钮可点击
                                if (auth.getUserInfo().id === currentProject.manager_id && !obj.data.actual_start_date && !obj.data.actual_end_date && $startBtn.is(':disabled')){
                                    $startBtn.removeAttr('disabled').removeClass('layui-btn-disabled')
                                }
                                // 当有实际开始日期，并且没有disabled属性时，添加disabled属性，【确认开始）按钮不可点击
                                if (obj.data.actual_start_date && !$startBtn.is(':disabled')) {
                                    $startBtn.attr('disabled', 'disabled').addClass('layui-btn-disabled')
                                }
                                // 有实际开始日期，无实际结束日期，有disabled属性，取消属性，【确认结束】按钮可点击
                                if (auth.getUserInfo().id === currentProject.manager_id && obj.data.actual_start_date && !obj.data.actual_end_date && $endBtn.is(':disabled')) {
                                    $endBtn.removeAttr('disabled').removeClass('layui-btn-disabled')
                                }
                                // 有实际结束日期，没有disabled属性，添加disabled属性，【确认结束】按钮不可点击
                                if (obj.data.actual_end_date && !$endBtn.is(':disabled')) {
                                    $endBtn.attr('disabled', 'disabled').addClass('layui-btn-disabled')
                                }

                                // 移除已有的click事件，避免重复绑定
                                $startBtn
                                    .off('click')
                                    .click(function(){
                                        let update = {}
                                        update.update = {}
                                        update.field = 'actual_start_date'
                                        const todayStr = util.toDateString(Date.now(), "yyyy-MM-dd")
                                        update.update['actual_start_date'] = todayStr
                                        updateNodeData(obj.data.id, update)
                                        layer.close(index)  // 关闭当前弹窗
                                    })
                                $endBtn
                                    .off('click')
                                    .click(function(){
                                        let update = {}
                                        update.update = {}
                                        update.field = 'actual_end_date'
                                        const todayStr = util.toDateString(Date.now(), "yyyy-MM-dd")
                                        update.update['actual_end_date'] = todayStr
                                        updateNodeData(obj.data.id, update)
                                        layer.close(index)  // 关闭当前弹窗
                                    })
                            }
                        })
                    }

                })

            } else if ( obj.event === 'tool-del') {  // 删除
                layer.confirm('确认删除么？', function (index) {
                    $.ajax({
                        url: `/api/v1/project/${obj.data.id}`,
                        type: "DELETE",
                        contentType: "application/json",
                        success: function (res){
                            if (!res.code){
                                layer.msg(res.msg, {
                                    icon: 1,
                                    time: 1000
                                }, function(){
                                    table.reloadData('project-table', {
                                        scrollPos: 'fixed'
                                    })
                                })
                            } else {
                                layer.msg(res.msg, {
                                    icon: 2,
                                    time: 1500,
                                })
                            }
                        }
                    })
                    layer.close(index);
                });
            } else if (obj.event === 'more') {
                // 更多-下拉菜单
                dropdown.render({
                    elem: this, // 触发事件的DOM对象
                    show: true, // 外部事件触发即显示
                    id: 'more-dropdown',
                    align: 'right', // 右对齐弹出
                    style: 'box-shadow: 1px 1px 10px rgb(0 0 0 / 12%);',  // 设置额外样式
                    data: [{
                        title: '删除',
                        id: 'delete'
                    },{
                        title: '审核',
                        id: 'audit'
                    },{
                        title: '退回编辑',
                        id: 'reject'
                    },{
                        title: '项目关闭',
                        id: 'close'
                    }]
                })
            }
        });

        // table 滚动时移除内部弹出的元素(操作列的more弹窗）
        const tableInst = table.getOptions('project-table');
        tableInst.elem.next().find('.layui-table-main').on('scroll', function (){
            dropdown.close('more-dropdown')
        })

        // 行双击事件( 单击事件为: row ) 暂时不用，修改了临时表名
        table.on('rowDouble(project-table-1)', function (obj){
            console.log(obj.data)
            let project_id = obj.data.id
            let plan_version = obj.data.plan_version
            console.log('当前项目： ' + project_id, '计划版本：' + plan_version, '计划发行状态：' + obj.data.is_released)

            let purl = `/api/v1/project/${obj.data.id}/tasks`

            // 本地化储存当前项目的id
            layui.data('project', {
                key: 'current_pid',
                value: obj.data.id
            })
            // 本地化存储当前项目的计划发行状态
            layui.data('project', {
                key: 'plan_is_released',
                value: obj.data.is_released
            })

            //console.log(obj)
            // 弹出项目详情页面
            layer.open({
                type: 1,
                title: false,
                //title: `${obj.data.customer}`,
                offset: 'r',
                anim: 'slideLeft',
                area: ['90%', '100%'],
                shadeClose: true,
                content: $('#project-detail-page'),
                closeBtn: 0

            })

            // 项目详细的初始tab切换，默认切换至项目计划tab
            element.tabChange('project-detail', 'plan')

            let plan_is_released = layui.data('project').plan_is_released
            console.log('plan_is_released:' ,plan_is_released)

            // 定义edit的编辑权限
            // 只有edit的当前行不是父节点时，才可编辑。
            // 当前项目计划没有发布时，才可以编辑
            let plan_editable = function (d){
                if(!d.isParent && !layui.data('project').plan_is_released) return 'text'
            }

            let actual_editable = function (d){
                return ''
            }

            // renderPlanTable('#project-plan-table', project_id, plan_version)

            // 渲染项目计划表格
            treeTable.render({
                elem: '#project-plan-table',
                id: 'project-plan-table',
                url: `/api/v1/project/${project_id}/node?version=${plan_version}`,
                //url: `/api/v1/project/${project_id}/node?version=1`,
                // toolbar: '#toolbar',
                // page: true,
                // limit: 30,
                height: 'full-200',
                css: [ // 设置单元格样式
                      // 取消默认的溢出隐藏，并设置适当高度
                      '.layui-table-cell{height: 50px; line-height: 40px;}',
                      '.layui-table-cell .layui-colorpicker{width: 38px; height: 38px;}',
                      '.layui-table-cell select{height: 36px; padding: 0 5px;}'
                    ].join(''),
                cols: [[
                        {field: 'id', title: 'ID', width:50, align: 'center', rowspan: 2, hide: true},
                        {field: 'node_id', title: '序号', width:50, align: 'center', rowspan: 2},
                        {field: 'name', title: '项目节点', width:320, rowspan: 2},
                        {title: '计划日期', width:360, align: "center" , colspan: 3},
                        {title: '实际日期', width:360, align: "center" , colspan: 3},
                        {field: 'remark', title: '备注', width:300, align: 'center', edit: plan_editable, rowspan: 2},
                        {field: 'owner', title: '负责人', width:160, align: 'center', edit: plan_editable, rowspan: 2},
                        {field: 'delay_type', title: '拖期类型', width:160, align: 'center', edit: actual_editable, rowspan: 2},
                        {field: 'delay_reason', title: '拖期说明', width:300, align: 'center', edit: actual_editable, rowspan: 2},
                ],[
                        {field: 'planned_start_date', title: '计划开始', width:110, align: 'center', event: 'date'},
                        {field: 'planned_end_date', title: '计划结束', width:110, align: 'center', event: 'date'},
                        {field: 'planned_period', title: '计划周期', width:110, align: 'center'},
                        {field: 'actual_start_date', title: '实际开始', width:110, align: 'center', event: 'date'},
                        {field: 'actual_end_date', title: '实际结束', width:110, align: 'center', event: 'date'},
                        {field: 'actual_period', title: '实际周期', width:110, align: 'center'},
                ]],
                tree: {
                    view: {
                        'expandAllDefault': true,  // 默认展开全部节点，默认为false
                    }
                },
                done: function (res, curr, count){
                    let options = this;
                    // 获取当前行数据 - 自定义方法
                    table.getRowData = function(tableId, elem){
                        let index = $(elem).closest('tr').data('index');
                        return table.cache[tableId][index] || {};
                        console.log(table.cache[tableId][index] || {});

                    };
                    // 展示数据 - 仅用于演示
                    let showData = function(data) {
                        return layer.msg('当前行最新数据：<br>'+ util.escape(JSON.stringify(data)), {
                          offset: '16px',
                          anim: 'slideDown'
                        });
                    };

                    // 修改数据库数据（根据id和更新的字段）
                    let updateData = function(id, update){
                        url = '/api/v1/project/node/' + id;

                        $.ajax({
                            method: "PUT",
                            url: url,
                            data: JSON.stringify(update),
                            contentType: "application/json",
                            //datatype: "json",
                            success: function (res){
                                layer.msg(res.msg, {
                                    icon: 1,
                                    time: 1000
                                }, function(){
                                    // layer.closeAll('page');
                                    treeTable.reloadData('project-plan-table', {
                                        scrollPos: 'fixed',
                                    })
                                })
                            },
                            error: function (res){
                                layer.msg(res.msg,{
                                    icon: 2,
                                    time: 1000
                                })
                            }
                        })
                    };


                    // 单元格编辑事件
                    table.on('edit(project-plan-table)', function (obj) {
                        console.log(obj)
                        let value = obj.value // 得到修改后的值
                        let data = obj.data // 得到所在行所有键值
                        let field = obj.field; // 得到字段名
                        let update = {};
                        update.update = {}
                        update.field = field
                        update.value = value
                        update.update[field] = value;

                        updateData(data.id, update);  // 更新服务器数据
                        // updateData(data.id, data);  // 更新服务器数据
                    });

                    // 单元格工具事件，对应表头中的event事件
                    table.on('tool(project-plan-table)', function (obj){
                        // let data = obj.data;  // 得到所在行所有键值

                        // 定义event事件的触发权限
                        // 如果点击的当前行为父节点，不触发任何操作
                        // 如何当前计划已经发布，不触发任何操作
                        if(obj.data.isParent || layui.data('project').plan_is_released){
                            return;
                        }
                        let id = obj.data.id;  // 得到所在行的id
                        let field = $(this).data('field');  // 得到字段名
                        let update = {};
                        update.update = {}
                        switch (obj.event) {
                            case "date":  // 所有日期类型单元格的处理
                                laydate.render({
                                    elem: this.firstChild,  // 固定写法
                                    show: true,  // 直接显示
                                    done: function (value, date){
                                        update.field = field
                                        update.value = value
                                        update.update[field] = value;
                                        updateData(id, update);  // 更新服务器数据
                                    }
                                })
                                break
                            case "status-dropdown":  // 完成状态的下拉菜单处理
                                dropdown.render({
                                    elem: this.firstChild,  // 固定写法
                                    show: true,  // 直接显示
                                    data: [{
                                        title: '未开始',
                                        id: 100
                                    },{
                                        title: '进行中',
                                        id: 101
                                    },{
                                        title: '已完成',
                                        id: 102
                                    }],
                                    click: function (data) {
                                        update[field] = data.title
                                        this.elem.text(data.title)  // 直接更改网页的显示
                                        // updateData(id, update);  // 更新服务器数据
                                    }
                                });
                                break;
                            case "get-user":
                                // let offset = $(this).offset()
                                // console.log(offset)
                                layer.open({
                                    type: 1, // page 层类型
                                    area: ['300px', '400px'],
                                    // offset: ['253px', '1000px'],
                                    title: false,
                                    shadeClose: true, // 点击遮罩区域，关闭弹层
                                    // maxmin: true, // 允许全屏最小化
                                    // 注: 这里特别对 select 设置了 lay-append-position 属性，以便与 layer 的定位方式保持一致
                                    content: '<form class="layui-form layui-padding-3" lay-filter="test"><select lay-append-to="body" lay-append-position="fixed"><option value="">请选择</option><option value="AAA1">选项 A1</option><option value="AAA2">选项 A2</option><option value="AAA3">选项 A3</option><option value="AAA4">选项 A4</option><option value="AAA5">选项 A5</option><option value="AAA6">选项 A6</option><option value="AAA7">选项 A7</option><option value="AAA8">选项 A8</option><option value="AAA9">选项 A9</option><option value="AAA10">选项 A10</option><option value="AAA11">选项 A11</option><option value="AAA12">选项 A12</option><option value="BBB">选项 B</option><option value="CCC">选项 C</option></select></form>',
                                    success: function (layero) {
                                        // 定向渲染 select
                                        form.render(layero.find('.layui-form select'));
                                        // 鼠标滑动 layer 内部滚动条时移除下拉框，以规避错位
                                        // 若 layer 内部不存在滚动条，以下代码可删除
                                        var selectElem = layero.find('.layui-form-select');
                                        layero.find('.layui-layer-content').on('scroll', function () {
                                            selectElem.removeClass('layui-form-selected');
                                            layui.$('.layui-select-panel-wrap').detach();
                                        });
                                    }
                                });
                        }

                    })
                    element.render()  // table渲染完成后，渲染进度条。否则进度条不显示。
                }

            });


        });


        // 添加/编辑表单提交事件
        form.on('submit(project-form-submit)', function (data) {
            const event = $(data.elem).attr('lay-event')
            let field = data.field; // 获取表单字段值

            if (event === 'submit'){
                field['status'] = '已提交'
            }

            let method = ''
            // 将项目编号和合同编号统一为大写
            field.contract = field.contract.toUpperCase()
            field.project_number = field.project_number.toUpperCase()
            // 将单选框的值转换为布尔值
            field.is_automation = field?.is_automation === 'true'
            console.log(field)

            if (field.id == 0){
                field.id = null;
                method = "POST";
                url = "/api/v1/project";
            }else{
                method = "PUT";
                url = `/api/v1/project/${field.id}`;
            }

            $.ajax({
                method: method,
                url: url,
                data: JSON.stringify(field),
                contentType: "application/json",
                //datatype: "json",
                success: function (res){
                    console.log(res)
                    layer.msg(res.msg, {
                        icon: 1,
                        time: 1000
                    }, function(){
                        layer.closeAll('page');
                        table.reloadData('project-table', {
                            scrollPos: 'fixed'
                        })
                    })
                },
                error: function (res){
                    console.log(res)
                    let msg = res.msg
                    if(res.status === 403){
                        msg = res.responseJSON.msg
                    }
                    layer.msg(msg,{
                        icon: 2,
                        time: 1000
                    })
                }
            })
            return false; // 阻止默认 form 跳转
        });

        // 项目：审核表单提交事件-temp
        form.on('submit(project-info-submit0)', function (data) {
            const event = $(data.elem).attr('lay-event')
            console.log(event)
            let field = data.field; // 获取表单字段值
            const projectId = field.id

            let update = {}
            update['id'] = projectId

            if (event === 'approve') {
                update['status'] = '已审核'
            } else if (event === 'reject') {
                update['status'] = '待提交'
            }

            // console.log(field)
            // console.log(update)

            $.ajax({
                method: 'PUT',
                url: `/api/v1/project/${field.id}`,
                data: JSON.stringify(update),
                contentType: "application/json",
                //datatype: "json",
                success: function (res) {
                    console.log(res)
                    layer.msg(res.msg, {
                        icon: 1,
                        time: 1000
                    }, function () {
                        layer.closeAll('page');
                        table.reloadData('project-table', {
                            scrollPos: 'fixed'
                        })
                    })
                },
                error: function (res) {
                    console.log(res)
                    layer.msg(res.msg, {
                        icon: 2,
                        time: 1000
                    })
                }
            })
            return false; // 阻止默认 form 跳转
        });

        // 项目：审核表单提交事件
        form.on('submit(project-info-submit)', function (data) {
            const event = $(data.elem).attr('lay-event')
            console.log(event)
            let field = data.field; // 获取表单字段值

            let update = {}
            update.event = event

            $.ajax({
                method: 'POST',
                url: `/api/v1/project/info_audit/${field.id}`,
                data: JSON.stringify(update),
                contentType: "application/json",
                success: function (res) {
                    console.log(res)
                    layer.msg(res.msg, {
                        icon: 1,
                        time: 1000
                    }, function () {
                        layer.closeAll('page');
                        table.reloadData('project-table', {
                            scrollPos: 'fixed'
                        })
                    })
                },
                error: function (res) {
                    console.log(res)
                    layer.msg(res.msg, {
                        icon: 2,
                        time: 1000
                    })
                }
            })
            return false; // 阻止默认 form 跳转
        });


        // 项目详细tab切换，点击tab时触发
        element.on('tab(project-detail)', function (obj){
            let id = obj.id
            if( id === "product_m" ){
                // 模拟数据
                  var ganttData = [
                    { id: 1, task: '任务A', start: '2023-10-01', end: '2023-10-05', progress: 80 },
                    { id: 2, task: '任务B', start: '2023-10-03', end: '2023-10-08', progress: 50 },
                    { id: 3, task: '任务C', start: '2023-10-06', end: '2023-10-10', progress: 30 }
                  ];

                  // 获取日期范围
                  function getDateRange(startDate, endDate) {
                    var dates = [];
                    var currentDate = new Date(startDate);
                    var endDate = new Date(endDate);
                    while (currentDate <= endDate) {
                      dates.push(new Date(currentDate).getDate()); // 提取“日”
                      currentDate.setDate(currentDate.getDate() + 1);
                    }
                    return dates;
                  }

                  // 获取所有任务的日期范围
                  var allDates = [];
                  ganttData.forEach(function (task) {
                    var dates = getDateRange(task.start, task.end);
                    allDates = allDates.concat(dates);
                  });
                  var uniqueDates = [...new Set(allDates)].sort((a, b) => a - b); // 去重并排序

                  // 动态生成表头
                  var cols = [
                    { field: 'task', title: '任务名称', width: 150, fixed: 'left' }
                  ];
                  uniqueDates.forEach(function (day) {
                    cols.push({
                      field: 'day_' + day,
                      title: day + '日',
                      width: 50,
                      align: 'center'
                    });
                  });

                  // 渲染表格
                  table.render({
                    elem: '#ganttTable',
                    cols: [cols],
                    data: ganttData.map(function (task) {
                      var row = { task: task.task };
                      var dates = getDateRange(task.start, task.end);
                      uniqueDates.forEach(function (day) {
                        row['day_' + day] = dates.includes(day) ? '▉' : ''; // 用方块表示任务
                      });
                      return row;
                    }),
                    page: false // 关闭分页
                  });
            } else if ( id === "automation_m" ) {
                // let current_pid = localStorage.getItem('current_pid')
                let current_pid = layui.data('project').current_pid
                // console.log(current_pid)
                // console.log('/api/v1/project/' + current_pid + '/tasks')
                // url = '/api/v1/project/' + current_pid + '/tasks'
                treeTable.render({
                    elem: '#project-amtask-table',
                    id: 'project-amtask-table',
                    url: '/api/v1/project/' + current_pid + '/tasks',
                    // url: url,
                    cols: [[
                        {field: 'id', title: 'ID', width:60 ,align: 'center', fixed: 'left'},
                        {field: 'title', title: '任务标题', minWidth: 300, fixed: 'left'},
                        {field: 'task_type', title: '任务类型', width:100, hide:true},
                        {field: 'creator', title: '创建者', align: 'center', width: 80, hide:true},
                        {field: 'owner', title: '负责人', align: 'center', width: 100, sort: true},
                        {field: 'planned_start_date', title: '计划开始日期', align: 'center', width: 120},
                        {field: 'planned_end_date', title: '计划完成日期', align: 'center', width: 120},
                        {field: 'actual_start_date', title: '实际开始日期', Width: 120, align: 'center', width: 120},
                        {field: 'actual_end_date', title: '实际完成日期', Width: 120, align: 'center', width: 120},
                        {field: 'planned_man_hours', title: '计划工时', align: 'center', width: 100},
                        {field: 'actual_man_hours', title: '实际工时', align: 'center', width: 100},
                        {field: 'status', title: '完成状态', align: 'center', width: 120, sort: true},
                    ]],
                    tree: {
                        view: {
                            'expandAllDefault': true,  // 默认展开全部节点，默认为false
                        },
                        customName: {
                            'name': 'title',
                        }
                    }
                })
            }

        });


        // 显示已完成 的switch切换事件
        form.on('switch(showAllSwitch)', function (data) {
            // 本地缓存数据
            layui.data('project', {
                key: 'projectShowAll',
                value: this.checked
            })
            if (this.checked) {  // 选中，即显示已完成
                url = baseUrl + '?showAll=1'
            } else {
                url = baseUrl
            }
            console.log('请求url:', url)
            table.reloadData('project-table', {
                url: url
            })
        })

        /**
         * 根据项目id和项目版本和状态状态更改项目计划的状态
         * @param {Object} update - 更新对象
         * @param {number} update.project_id - 项目id
         * @param {number} update.plan_version - 计划版本
         * @param {String} update.status - 更改后的状态
         * returns
         */
        const planStatusUpdate = function (update) {
            $.ajax({
                method: "PUT",
                url: `/api/v1/project/plan_version/status_update`,
                data: JSON.stringify(update),
                contentType: "application/json",
                success: function (res){
                    layer.msg(res.msg, {
                        icon: 1,
                        time: 1000
                    }, function(){
                        table.reload('project-table')
                        treeTable.reload('project-plan-table')
                    })
                },
                error: function (res){
                    layer.msg(res.msg,{
                        icon: 2,
                        time: 1000
                    })
                }
            })
        };

    });

</script>
{% endblock %}